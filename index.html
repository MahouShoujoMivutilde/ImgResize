<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <html>
    <script type="text/javascript" src="https://raw.githubusercontent.com/viliusle/Hermite-resize/master/src/hermite.js"></script>
    <title>Re</title>
    <style>
        body {
            margin: 0;
            background: #262626 left fixed !important;
            background-size: cover !important;
            background-repeat: no-repeat !important;
            height: 100vh;
            width: 100vw;
            font-family: Consolas;
            font-size: 2vh;
            color: #666;
        }
        img {
            max-height: 100vh;
            max-width: 100vw;
            display: block;
            margin: 0 auto;
            box-shadow: 0 2px 30px 1px black;
        }
        span {
            transform: rotate(90deg);
            top: 35vh;
            left: -10vw;
            display: block;
            margin: 0 auto;
            z-index: -1;
            position: fixed;
            font-family: Arial;
            font-size: 5vh;
            color: rgba(250, 250, 250, 0.8);
            opacity: 0.07;
        }
        .tg {
            top: 1vh;
            left: calc(1vh + 5px);
            border-collapse: collapse;
            border-spacing: 0; 
            border: none;
            position: fixed;
        }
        .tg td {
            font-family: Arial, sans-serif;
            font-size: 14px;
            padding: 10px 5px;
            border-style: solid;
            border-width: 0px;
            overflow: hidden;
            word-break: normal;
        }
        .tg th {
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: normal;
            padding: 10px 5px;
            border-style: solid;
            border-width: 0px;
            overflow: hidden;
            word-break: normal;
        }
        .tg .tg-oeq0 {
            font-size:x-large;
            vertical-align: top
        }
        input {
            text-align: center;
            font-family: Consolas;
            font-size: x-large;
            color: #aaa;
            background: #444;
            border: none;
            width: 100px;
        }
    </style>
    <script>
        // http://stackoverflow.com/a/18234317
        String.prototype.formatUnicorn = String.prototype.formatUnicorn ||
        function () {
            "use strict";
            var str = this.toString();
            if (arguments.length) {
                var t = typeof arguments[0];
                var key;
                var args = ("string" === t || "number" === t) ?
                    Array.prototype.slice.call(arguments)
                    : arguments[0];
                for (key in args) {
                    str = str.replace(new RegExp("\\{" + key + "\\}", "gi"), args[key]);
                }
            }
            return str;
        }
        // удаление предыдущих изображений
        function RemovePrevious() {
            try {
                document.getElementsByTagName("img")[0].remove();
            } catch(e) {}
        }

        function convertCanvasToImage(canvas) {
            var image = new Image();
            image.src = canvas.toDataURL("image/jpeg"); // base64
            return image;
        }

        // request permission on page load
        document.addEventListener("DOMContentLoaded", function () {
            var url = window.location.href;
            if (Notification.permission !== "granted" && url.search("http") != -1)  {
                Notification.requestPermission();
                console.log("страница не локальная \n запрос разрешения на уведомления с характеристиками масштабируемой картинки");
            }
        });

        function notifyMe(or_w, or_h, w, h) {
            var title;
            if (or_h !== h || or_w !== w) {
                title = "{0}x{1} → {2}x{3}".formatUnicorn(or_w, or_h, w, h)
            } else {
                title = "image → jpeg"
            }
            var notification = new Notification(title, {
                icon: "notification.png"
            });
        }

        function getMaxSide() {
            var val = parseInt(document.getElementById("max_side").value);
            console.log(val);
            return val;
        }
        function actuallyResize() {
            return 1;
        }

        function ResizeAndRender(url) {
            var img = new Image();
            img.src = url;

            img.onload = function() {
                var height = img.height;
                var width = img.width;
                var k, h, w;
                var max_side = getMaxSide();

                // с использованием основного свойства дроби подбирается размер меньшей стороны
                if (width <= max_side && height <= max_side) {
                    w = width;
                    h = height;
                } else if (width > height) {
                    w = max_side;
                    k = width/w;
                    h = Math.round(height/k);
                } else if (width < height) {
                    h = max_side;
                    k = height/h;
                    w = Math.round(width/k);
                } else {
                    w = max_side;
                    h = max_side;
                }
                
                var canvas = document.createElement("canvas");
                canvas.width = w;
                canvas.height = h;
                var CTX = canvas.getContext("2d");
                CTX.fillStyle = "#fdfeff"; //на случай png с прозрачностью, r253 g254 b255 - для хрома-ки выделения
                CTX.fillRect(0, 0, w, h);
                CTX.drawImage(img, 0, 0, w, h); // "рисуем" канвас картинку, но не выводим на страницу
                var image = convertCanvasToImage(canvas);       
                document.getElementById("c").appendChild(image); // собственно, изображение, полученное из канвас
                //new_image = document.getElementsByTagName("img")[0]
                image.onload = function() {
                    console.log("{0}x{1} → {2}x{3}, альфа-канал (если был ^__^) заполнен #fdfeff".formatUnicorn(width, height, w, h));
                    notifyMe(height, width, h, w);
                }
            }
        }
        
        // http://stackoverflow.com/a/6338207
        document.onpaste = function(event){
            RemovePrevious();
            var items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (index in items) {
                var item = items[index];
                if (item.kind === 'file') {
                    var blob = item.getAsFile();
                    var reader = new FileReader();
                    reader.onload = function(event){
                            ResizeAndRender(event.target.result); // data url
                        }; 
                    reader.readAsDataURL(blob);
                }
            }
        }

        var readImage = function(imgFile) {
            RemovePrevious();
            if(!imgFile.type.match(/image.*/)) {console.log("это не картинка!: ", imgFile.type); return;}
            var reader = new FileReader();
            reader.onload = function(e) {ResizeAndRender(e.target.result);}
            reader.readAsDataURL(imgFile);
        }

        /* Собственно, сам drag and drop */
        document.addEventListener("dragover", function(e) {e.preventDefault();}, true);
        document.addEventListener("drop", function(e) {e.preventDefault(); readImage(e.dataTransfer.files[0]);}, true);
    </script>
</head>
    <body>
        <div id="c"></div>
        <span>ctrl+v & drag and drop</span>

        <table class="tg">
            <tr>
                <td class="tg-oeq0">max side:</td>
                <td class="tg-oeq0"><input type="text" name="name" id="max_side" value="2560" /></td>
            </tr>
            <!-- когда-нибудь...
            <tr>
                <td class="tg-oeq0">max height:<br></td>
                <td class="tg-oeq0"><input type="text" name="name" id="max_height" value="" /></td>
            </tr>
            <tr>
                <td class="tg-oeq0">max width:</td>
                <td class="tg-oeq0"><input type="text" name="name" id="max_width" value="" /></td>
            </tr> 
            -->
        </table>
    </body>
</html>